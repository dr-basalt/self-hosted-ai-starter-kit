FROM python:3.11-slim

# Variables d'environnement
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV OPENWEBUI_PORT=3000
ENV MEMORY_API_PORT=5001

# Installation des dépendances système
RUN apt-get update && apt-get install -y \
    curl \
    git \
    curl \
    wget \
    build-essential curl \
    ffmpeg \
    libsndfile1 \
    libportaudio2 \
    portaudio19-dev \
    python3-dev \
    && rm -rf /var/lib/apt/lists/*

# Création du répertoire de travail
WORKDIR /app

# Copie des fichiers de configuration
COPY requirements.txt .
COPY openwebui-config.yml .
COPY openwebui-memory.py .

# Installation des dépendances Python
RUN pip install --no-cache-dir -r requirements.txt

# Installation d'OpenWebUI
RUN git clone https://github.com/open-webui/open-webui.git /app/open-webui
WORKDIR /app/open-webui

# Installation des dépendances OpenWebUI
RUN pip install --no-cache-dir -r /app/open-webui/backend/requirements.txt

# Installation des dépendances audio pour STT/TTS (désactivées temporairement)
# RUN pip install --no-cache-dir pydub faster-whisper openai-whisper

# Installation de Node.js et npm pour construire le frontend
RUN apt-get update && apt-get install -y nodejs npm ffmpeg

# Construction du frontend
WORKDIR /app/open-webui
RUN npm install --legacy-peer-deps
RUN npm install @tiptap/suggestion y-protocols --legacy-peer-deps
RUN npm run build

# Création du répertoire pour les certificats SSL
RUN mkdir -p /app/certs

# Génération d'un certificat SSL auto-signé pour HTTPS
RUN openssl req -x509 -newkey rsa:4096 -keyout /app/certs/key.pem -out /app/certs/cert.pem -days 365 -nodes -subj "/C=FR/ST=IDF/L=Paris/O=OpenWebUI/CN=localhost"

# Configuration d'OpenWebUI
COPY ../openwebui-config.yml /app/open-webui/data/config.yml

# Script de démarrage
COPY ../start-openwebui.sh /app/start-openwebui.sh
COPY ../configure-openwebui.py /app/configure-openwebui.py
RUN chmod +x /app/start-openwebui.sh
RUN chmod +x /app/configure-openwebui.py

# Exposition des ports
EXPOSE 3000 5001

# Point d'entrée
ENTRYPOINT ["/app/start-openwebui.sh"]
